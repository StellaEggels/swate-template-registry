@using STRService.Extensions;

@page "/templates"
@inject IDbContextFactory<SwateTemplateDb> SwateTemplateDbContextFactory
@rendermode InteractiveServer

<style>
    .dropdown-content {
        max-height: 300px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }
</style>

<h1>All available Swate templates</h1>

@if (TemplateSummaries == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <input @bind="searchTerm" @bind:event="oninput" placeholder="Search by name" />
    <details class="dropdown" style="cursor: pointer;" readonly value="@string.Join(" , ", SelectedOrganisations)">
        <summary>Communities</summary>
        <ul>
            <li>
                <label>
                    <input type="checkbox" id="All Communities" @onchange="() => ToggleAllOrganisations()"
                           checked="@HasAllOrganisations()" />
                    All Communities
                </label>
            </li>
            @foreach (var org in DistinctOrganisations)
            {
                <li>
                    <label>
                        <input type="checkbox" id="@org" @onchange="() => ToggleOrganisation(org)"
                               checked="@SelectedOrganisations.Contains(org)"/>
                        @org
                    </label>
                </li>
            }
        </ul>
    </details>
    <details class="dropdown" style="cursor: pointer;" readonly value="@string.Join(" , ", SelectedTags)">
        <summary>Tags</summary>
        <ul class="dropdown-content">
            <li>
                <input type="text" @bind="searchTag" @bind:event="oninput" placeholder="Search by tag" />
            </li>
            @foreach (var tag in DistinctTags)
            {
                <li>
                    <label>
                        <input type="checkbox" id="@tag" @onchange="() => ToggleTag(tag)"
                                checked="@SelectedTags.Contains(tag)" />
                        @tag
                    </label>
                </li>
            }
        </ul>
    </details>

    <div class="overflow-auto">
        <table class="table">
            <thead>
                <tr>
                    <th scope="col" @onclick="() => SortByName()" style="cursor: pointer;">
                        Name @GetSortIcon("Name")
                    </th>
                    <th scope="col">Description</th>
                    <th scope="col">Latest stable version</th>
                    <th scope="col" @onclick="() => SortByReleaseDate()" style="cursor: pointer;">
                        Release date @GetSortIcon("ReleaseDate")
                    </th>
                    <th scope="col">Tags</th>
                    <th scope="col">Total Downloads</th>
                    <th scope="col">Id</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var templateSummary in FilteredTemplates)
                {
                    <TemplateSummaryRow summary="@templateSummary"></TemplateSummaryRow>
                }
            </tbody>
        </table>
    </div>
}

@code
{
    ///  <summary>
    /// This is the collection of all templates from the database.
    /// </summary>
    private TemplateSummary[]? TemplateSummaries;
    /// <summary>
    /// search string in input field
    /// </summary>
    private string searchTerm = string.Empty;
    private string searchTag = string.Empty;
    private string sortColumn = "Name";

    private HashSet<string> SelectedOrganisations = new() { "DataPLANT" };
    private HashSet<string> SelectedTags = new();

    private bool sortAscending = true;
    private bool isDropdownOpen = false;
    private bool areAllCommunitiesSelected => SelectedOrganisations.Count == 0;

    private void SortByName()
    {
        SortByColumn("Name");
    }

    private void SortByReleaseDate()
    {
        SortByColumn("ReleaseDate");
    }

    private void SortByColumn(string column)
    {
        if (sortColumn == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
    }

    private string GetSortIcon(string column)
    {
        if (sortColumn != column) return "▲▼";
        return sortAscending ? "▲" : "▼";
    }
    private bool IsDropdownOpen = false;

    private void ToggleDropDown()
    {
        isDropdownOpen = !isDropdownOpen;
    }

    private bool HasAllOrganisations()
    {
        return SelectedOrganisations.Contains("All Communities");
    }

    private void ToggleAllOrganisations()
    {
        if (HasAllOrganisations())
        {
            SelectedOrganisations.Clear();
        }
        else
        {
            SelectedOrganisations = DistinctOrganisations.ToHashSet();
            SelectedOrganisations.Add("All Communities");
            SelectedOrganisations.Distinct();
        }
    }
    
    private TemplateSummary[] FilteredTemplatesByName => string.IsNullOrWhiteSpace(searchTerm)
        ? TemplateSummaries
        : TemplateSummaries?.Where(r => r.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
        .ToArray();

    private string[] DistinctOrganisations => TemplateSummaries
        .Select(t => t.Organisation)
        .Where(org => !string.IsNullOrWhiteSpace(org))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .OrderBy(org => org)
        .ToArray();

    private string[] DistinctTags => TemplateSummaries
        .SelectMany(t => t.Tags)
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .Where(tag => !string.IsNullOrWhiteSpace(tag))
        .OrderBy(tag => tag)
        .ToArray();

    private TemplateSummary[] FilteredTemplates =>
        FilteredTemplatesByName
            .Where(t => t.Organisation != null && SelectedOrganisations.Contains(t.Organisation))
        .ToArray()
        .SortTemplatesBy(sortColumn, sortAscending);

    private void ToggleOrganisation(string org)
    {
        if (SelectedOrganisations.Contains(org))
        {
            SelectedOrganisations.Remove(org);
            SelectedOrganisations.Remove("All Communities");
        }
        else
        {
            SelectedOrganisations.Add(org);
        }
    }

    private void ToggleTag(string tag)
    {
        if (SelectedTags.Contains(tag))
        {
            SelectedTags.Remove(tag);
        }
        else
        {
            SelectedTags.Add(tag);
        }
    }

    private void ClearCommunities()
    {
        SelectedOrganisations.Clear();
    }

    protected override async Task OnInitializedAsync()
    {
        using var database = await SwateTemplateDbContextFactory.CreateDbContextAsync();
        var metadata = await database.Metadata.ToArrayAsync();
        var templates = await database.Templates.ToArrayAsync();

        var latestTemplates =
            metadata
            .OrderByDescending(p => p.MajorVersion)
            .ThenByDescending(p => p.MinorVersion)
            .ThenByDescending(p => p.PatchVersion)
            .FirstOrDefault();

        var templateSummaries =
            metadata
                .GroupBy(p => p.Id)
                .ToList()
                .Select(group =>
                    {
                        var downloads =
                            database.Downloads
                            .Where(p => p.TemplateId == group.Key)
                            .Sum(d => d.DownloadCount);

                        var latestTemplate =
                            group
                                .Where(p => p.BuildMetadataVersionSuffix == "" && p.BuildMetadataVersionSuffix == "")
                                .OrderByDescending(p => p.MajorVersion)
                                .ThenByDescending(p => p.MinorVersion)
                                .ThenByDescending(p => p.PatchVersion)
                                .FirstOrDefault();

                        return new TemplateSummary
                        {
                            Id = group.Key,
                            Name = latestTemplate.Name,
                            Description = latestTemplate.Description,
                            Tags = (latestTemplate?.Tags ?? []).Select(t => t.Name).ToArray(),
                            ReleaseDate = latestTemplate.ReleaseDate,
                            LatestVersion = latestTemplate.GetSemanticVersionString(),
                            TotalDownloads = downloads,
                            Organisation = latestTemplate.Organisation
                        };
                    }
                )
                .OrderBy(r => r.Name)
                .ToArray();

        TemplateSummaries = templateSummaries;
    }
}
